!function(a){var b="rangeslider";a.fn[b]=function(a){return this.each(function(){new c(this,a)})};var c=function(c,d){var e,f,g,h,i,j,k=this;e=a(c),j=e.attr("value"),i=e.attr("id"),this.options=a.extend(!0,{},a[b].options,{min:e.attr("min"),max:e.attr("max")},d),e.attr({id:i,"class":b,min:this.options.min,max:this.options.max}).css("position","relative").val(j),f=a('<div class="'+b+'-handler"></div>'),f.appendTo(e),this.$slider=e,this.$sliderHandler=f,this.sliderWidth=g=e.width(),this._sliderOffsetLeft=e.offset().left,this._handlerWidth=h=f.width(),this._maxLeft=g-h/2,this._minLeft=-h/2,f.css({position:"absolute",fontSize:"0"}).css({left:-this._handlerWidth/2,top:-e.height()/2}),e.on("mousedown."+b,function(c){c.preventDefault(),k.update(c),a(document).on("mousemove."+b,a.proxy(k.update,k)).on("mouseup."+b,function(){a(document).off("."+b)})}),f.on("mousedown."+b,function(c){c.preventDefault(),a(document).on("mousemove."+b,a.proxy(k.update,k)).on("mouseup."+b,function(){a(document).off("."+b)})}),e.data("slider",this)};a[b]=a.extend(c,{prototype:{_percent:null,getMin:function(){return this.options.min},getMax:function(){return this.options.max},getValue:function(){return this.getPercent()*this.options.max},setValue:function(a){var b=(a-this.options.min)/(this.options.max-this.options.min);this.setHandlerLeft(b*this._maxLeft-this._handlerWidth/2)},getPercent:function(){return this._percent},getHandlerLeft:function(){return this._handlerLeft},setHandlerLeft:function(a){a=Math.max(a,this._minLeft),a=Math.min(a,this._maxLeft),this.$sliderHandler.css("left",a),this._handlerLeft=a,this._percent=(this._handlerLeft+this._handlerWidth/2)/(this._maxLeft-this._minLeft)},update:function(a){a.preventDefault(),this._sliderOffsetLeft=this.$slider.offset().left,this.setHandlerLeft(a.pageX-this._sliderOffsetLeft-this._handlerWidth/2);var c=this.getPercent()*(this.options.max-this.options.min)+this.options.min;this.$slider.val(c),this.$slider.trigger("change."+b,[c,this.getPercent()])}}}),a[b].options={min:0,max:100}}(jQuery),function(a,b){var c="crop",d=function(b,d){var e=this,f=new Image,g=function(b,d){return a("<"+b+"/>",{"class":c+d.charAt(0).toUpperCase()+d.slice(1)})};this.$image=a(b).wrap(g("div","frame")),this.options=a.extend({},this.options,{width:this.$image.attr("width"),height:this.$image.attr("height"),style:this.$image.css(["display","left","top","width","height"]),$handler:this.$image},d),this.$frame=this.$image.parent(),this.$image.data("naturalWidth",d.naturalWidth),this.$image.data("naturalHeight",d.naturalHeight),this.$image.hide().addClass(c+"Image").data(c,this).on("load."+c,function(){var a,b;f.src=e.$image.attr("src"),a=e.$image.data("naturalWidth"),b=e.$image.data("naturalHeight"),e.minPercent=Math.max(a?e.options.width/a:1,b?e.options.height/b:1),e.focal={x:Math.round(a/2),y:Math.round(b/2)},e.zoom(e.minPercent),e.$image.fadeIn("fast",function(){e.$loadingMask.hide()})}).trigger("load."+c),this.options.$handler.on("dragstart."+c,function(a){a.preventDefault()}).on("mousedown."+c,function(b){b.preventDefault(),a(document).on("mousemove."+c,{mouse:{x:b.pageX,y:b.pageY},image:{x:parseInt(e.$image.css("left"),10),y:parseInt(e.$image.css("top"),10)}},a.proxy(e.drag,e)).on("mouseup."+c,function(){a(document).off("."+c)})}),this.$loadingMask=g("span","loading").append(this.options.loading),this.$frame.css({width:this.options.width,height:this.options.height}).append(this.$loadingMask).hover(function(){e.$frame.toggleClass("hover")}),this.options.controls!==!1&&this.$frame.append(g("div","controls").append(g("span","text").append(this.options.controls)).append(g("a","zoomIn").on("click."+c,a.proxy(this.zoomIn,this))).append(g("a","zoomOut").on("click."+c,a.proxy(this.zoomOut,this))))};a[c]=a.extend(d,{prototype:{percent:null,options:{width:320,height:180,zoom:10,stretch:1,loading:"Loading...",controls:"Click to drag"},zoom:function(a){this.percent=Math.max(this.minPercent,Math.min(this.options.stretch,a)),console.log(this.percent),this.$image.width(Math.ceil(this.$image.data("naturalWidth")*this.percent)),this.$image.height(Math.ceil(this.$image.data("naturalHeight")*this.percent)),this.$image.css({left:d.fill(-Math.round(this.focal.x*this.percent-this.options.width/2),this.$image.width(),this.options.width),top:d.fill(-Math.round(this.focal.y*this.percent-this.options.height/2),this.$image.height(),this.options.height)}),this.update()},drag:function(a){this.$image.css({left:d.fill(a.data.image.x+a.pageX-a.data.mouse.x,this.$image.width(),this.options.width),top:d.fill(a.data.image.y+a.pageY-a.data.mouse.y,this.$image.height(),this.options.height)}),this.update()},zoomIn:function(){return!!this.zoom(this.percent+1/(this.options.zoom-1||1))},zoomOut:function(){return!!this.zoom(this.percent-1/(this.options.zoom-1||1))},update:function(){this.focal={x:Math.round((this.options.width/2-parseInt(this.$image.css("left"),10))/this.percent),y:Math.round((this.options.height/2-parseInt(this.$image.css("top"),10))/this.percent)},this.$image.trigger(a.Event("change."+c,{cropX:-Math.floor(parseInt(this.$image.css("left"),10)/this.percent),cropY:-Math.floor(parseInt(this.$image.css("top"),10)/this.percent),cropW:Math.round(this.options.width/this.percent),cropH:Math.round(this.options.height/this.percent),stretch:this.percent>1}))},destroy:function(){this.$image.removeClass(c+"Image").css(this.options.style).off("."+c).removeData(c).siblings().unwrap().remove()}},fill:function(a,b,c){return c>a+b&&(a=c-b),a>0?0:a}}),a.fn[c]=function(a){return this.each(function(){new d(this,a)})}}(jQuery),function(){var a=window.ImageCropper=function(a,b){var c,d,e,f,g,h,i;this.options=$.extend(!0,{width:320,height:320,cropWidth:220,cropHeight:220},b),a.css({width:this.options.width,height:this.options.height}).addClass("cropper"),this.$image=c=$("<img>").attr({width:this.options.cropWidth,height:this.options.cropHeight}),this.$cropperMask=h=$('<div class="cropper-mask"></div>').css({width:this.options.cropWidth,height:this.options.cropHeight,padding:(this.options.width-this.options.cropWidth)/2,overflow:"hidden",position:"relative"}),i=$('<div class="cropper-mask-after"></div>').css({position:"absolute",top:0,left:0,width:this.options.cropWidth,height:this.options.cropHeight,borderWidth:(this.options.width-this.options.cropWidth)/2}),d=$('<div class="cropper-controls"></div>'),this.$zoomIn=e=$('<span class="cropper-zoom-in"></span>'),this.$zoomOut=f=$('<span class="cropper-zoom-out"></span>'),this.$zoomSlider=g=$("<span></span>"),a.append(h.append(c).append(i)).append(d.append(f).append(g).append(e))};$.extend(!0,a.prototype,{setImage:function(a,b,c,d){var e,f=this,g=this.$cropperMask,h=this.$zoomSlider;this.options.stretch=d||1,this.options.url=a,this.crop&&(this.$zoomIn.off(),this.$zoomOut.off(),g.off(),h.off(),this.$cropFrame.replaceWith(this.$image),this.$zoomSlider.empty()),this.$image.attr("src",a),this.crop=e=this.$image.crop({naturalWidth:b,naturalHeight:c,controls:!1,$handler:this.$cropperMask,stretch:this.options.stretch,loading:""}).on("change.crop",function(a){f._clipX=a.cropX,f._clipY=a.cropY,f._clicpWidth=a.cropW,f._clipHeight=a.cropH}).data("crop"),this.$cropFrame=this.$image.parent().css("overflow","visible"),this.slider=h.rangeslider({min:e.minPercent,max:this.options.stretch}).data("slider"),g.on("mousewheel",function(a){a.originalEvent.wheelDelta>0?f.zoomIn():f.zoomOut()}),this.$zoomIn.on("click",$.proxy(this.zoomIn,this)),this.$zoomOut.on("click",$.proxy(this.zoomOut,this)),h.on("change.rangeslider",function(a,b){e.zoom(b)})},getCropZone:function(){return{x:this._clipX,y:this._clipY,width:this._clicpWidth,height:this._clipHeight,cropWidth:this.options.cropWidth,cropHeight:this.options.cropHeight,url:this.options.url}},zoomIn:function(){this.crop.zoomIn(),this.slider.setValue(this.crop.percent)},zoomOut:function(){this.crop.zoomOut(),this.slider.setValue(this.crop.percent)}})}(),Airdroid.Module.TestImageCropper=Airdroid.Util.extend(Airdroid.Base,{events:{"click .addImage":"addImage","click .changeCropResult":"changeCropResult"},imageParams:{1:{url:"http://192.168.40.186/airdroid_pc/bower_components/jQuery-crop-ie6/beach.jpg",width:1200,height:799},2:{url:"http://kbz.airdroid.com/airdroid_pc/test-tmp/34.jpg",width:100,height:100},3:{url:"http://kbz.airdroid.com/airdroid_pc/test-tmp/56.jpg",width:416,height:741},4:{url:"http://kbz.airdroid.com/airdroid_pc/test-tmp/78.png",width:45,height:36}},_construct:function(){var a=this;Airdroid.Util.addPCInterface({triggerActive:function(b){var c=JSON.parse(b);switch(c.operation){case a.pcApi.triggerActive.action.close:alert("");break;case a.pcApi.triggerActive.action.selectImage:a.addImage()}},triggerCropImage:function(a){var b=JSON.parse(a);alert("ï¼Œ: "+JSON.stringify(b.data))}})},onCreate:function(a){var b=this;this.parentModule=a,this._refDOM=this.containDom=$(b.util.getTemplate("Test",a.moduleName)),a.setTestApiContent(this._refDOM)},addImage:function(){var a=this.find(".selectCropImage").val();PC_API("ImageCropper_setCropImage",this.imageParams[a])},changeCropResult:function(){var a=this.find(".cropResult").val();PC_API("ImageCropper_setCropResult",{code:a})}}),Airdroid.Module.ImageCropper=Airdroid.Util.extend(Airdroid.Base,{moduleName:Airdroid.Config.Module.ImageCropper,events:{"click .item-btn-cancel":"cancelHandle","click .item-btn-ok":"cropHandle","click .item-btn-select":"selectHandle"},_construct:function(){},_imageCropper:null,onCreate:function(){var a=this;if(this.clear(),this._refDOM=$(a.util.getTemplate("ImageCropper","index")),this.setContent(this._refDOM),this._okDom=this.find(".item-btn-ok"),this._selectDom=this.find(".item-btn-select"),this._tipDom=this.find(".item-tip-con"),this.config.isDebug){var b=new Airdroid.Module["Test"+this.moduleName];b.createAppView(this)}this.registerWebInterface({setCropImage:"setCropImage",setCropResult:"setCropResult"})},onCreated:function(){this.util.checkIsLtIE7()&&$(window).trigger("resize")},cancelHandle:function(){var a=this;this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.triggerActive.name,operation:a.pcApi.triggerActive.action.close}))},cropHandle:function(){var a=this;this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.triggerCropImage.name,data:a._imageCropper.getCropZone()})),this._tipDom.removeClass("item-tip-error").addClass("item-tip-saving"),this.util.disableDom(this._okDom),this.util.disableDom(this._selectDom)},selectHandle:function(){var a=this;this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.triggerActive.name,operation:a.pcApi.triggerActive.action.selectImage}))},setImage:function(a){this.find(".item-body").empty().attr("data-size",a.width+"_"+a.height),this._tipDom.removeClass("item-tip-error"),this._imageCropper=new ImageCropper(this.find(".item-body"),{width:200,height:200,cropWidth:160,cropHeight:160});var b=parseInt(a.width),c=parseInt(a.height),d=1;d=Math.max(d,parseFloat((260/b).toFixed(1)),parseFloat((260/c).toFixed(1))),this._imageCropper.setImage(a.url,b,c,d),this.find(".item-body").css("background-image","none")},setCropImage:function(a){this.setImage(a)},setCropResult:function(a){this._tipDom.removeClass("item-tip-saving"),"1"==a.code?this.cancelHandle():this._tipDom.addClass("item-tip-error"),this.util.enableDom(this._okDom),this.util.enableDom(this._selectDom)}});