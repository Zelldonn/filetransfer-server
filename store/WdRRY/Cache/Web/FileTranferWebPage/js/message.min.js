Airdroid.Module.TestMessage=Airdroid.Util.extend(Airdroid.Base,{events:{"click .addSMSItem":"addSMSItemHandle","click .changeStateSubmit":"changeSMSState","click .clearAllItemSubmit":"clearAll","click .loadMoreSMS":"loadMoreSMS","click .showDelayMsg":"showDelayMsg","click .startDel":"setDel","click .delSelectItem":"delSelectItem","click .delAll":"delAll"},defaultOpt:{icon:"../../img/contact_avatar.png",body:"",date:"",state:"3",from:"1",to:"2",type:"0",cid:""},_construct:function(){var a=this,b=0;this._data=(new Date).getTime(),Airdroid.Util.addPCInterface({triggerPageLoaded:function(a){var b=JSON.parse(a);0===b.isInit&&PC_API("Common_initEnv",{lang:"zh-cn",isResend:!0})},askMessageData:function(c){var d=JSON.parse(c),e=d.time,f=parseInt(d.count),g=d.order,h={search:{keyword:"aa%^_^",currSid:"3",currMsgId:"",sidList:["0","1","2","3"]},list:[],order:g,time:e},i="",j=function(b,c){for(var d=0;f>d;d++){"1"==b?i=c+36e5*(d+1):"0"==b&&(i=c-36e5*(f-d+1));var e={id:a.getUniqId(),date:i,body:"3333aA^_^：＃＃＃（: ##19850501#）。。http://www.vip.watsons.com.cn/web/Icp.do, 【】",from:[1,2][d%2]};h.list.push($.extend(!0,{},a.defaultOpt,e))}};0===parseInt(e)?(j("1",a._data),h.search.currMsgId=h.list[2].id):"1"==g?j("1",e):"0"==g&&j("0",e),b+=1,b>3&&(h.list=[]),PC_API("Message_addSMSItems",h)}})},onCreate:function(a){var b=this;this.parentModule=a,this._refDOM=this.containDom=$(b.util.getTemplate("Test",a.moduleName)),a.setTestApiContent(this._refDOM)},getUniqId:function(){return Math.floor(1e7*Math.random())},addSMSItemHandle:function(){var a={};a.id=this.getUniqId(),a.date=(new Date).getTime();var b=this.find(".itemFrom").val();"1"==b?a.from="1":(a.from="0",a.to=1),a.state=parseInt(this.find(".itemState").val()),a.body=this.find(".itemName").val(),this.addSMSItem(a)},addSMSItem:function(a){var a=a||{};PC_API("Message_addSMSItems",{list:[$.extend(!0,{},this.defaultOpt,a)],order:1,time:0})},changeSMSState:function(a){var b=$(a.currentTarget).parent().find(".changeItemState").val(),c=$(".sms-list-item");if(c.length>0){var d=$(c.get(0)).attr("data-file-id");PC_API("Message_setSMSState",{id:d,state:b})}},clearAll:function(a){PC_API("Message_clearAll")},loadMoreSMS:function(){var a=this,b=this.find(".itemOrder").val();if("1"===b)var c=parseInt($(".sms-list-item:last").attr("data-date"))||0;else var c=parseInt($(".sms-list-item:first").attr("data-date"))||0;this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.askMessageData.name,time:c,count:10,order:b}))},showDelayMsg:function(){Airdroid.Util.showDelayMsg($("body"),"h234234234234234234234")},setDel:function(a){var b=$(a.currentTarget).attr("data-type");PC_API("Message_setDel",{type:b}),$(a.currentTarget).attr("data-type","1"==b?"0":"1")},delSelectItem:function(){var a=[];$(".sms-list-item.item-checked").each(function(){a.push($(this).attr("data-file-id"))}),PC_API("Message_smsOperate",{id:a,operation:"1"})},delAll:function(){PC_API("Message_clearAll",{})}}),Airdroid.Module.Message=Airdroid.Util.extend(Airdroid.Base,{scrollbarStickBottom:!0,moduleName:Airdroid.Config.Module.Message,SMS_STATE:{sending:"1",failed:"2",successed:"3"},defaultOpt:{icon:"../../img/contact_avatar.png",body:"",date:"",state:"",from:"0",to:"0",type:"0",cid:""},SMS_ACTION:{del:"1"},_isLoadingData:null,_delItemArr:[],_isCurrentDelState:!1,events:{"click a.linkable":"linkClickHandle","click .item-refresh":"refreshDataHandle","click .mod-Message-retryList .icon-sms-error":"retrySendSMS","click .sms-list-item":"itemClickHandle","click .item-checkbox":"itemCheckClickHandle"},MAX_COUNT:90,_hasHistory:!0,_construct:function(){},onCreate:function(){var a=this;this.clear(),this._refDOM=$(a.util.getTemplate("Message","index")),this.setContent(this._refDOM),this._listDom=this.find(".mod-Message-list");var b=this.util.getEnv();if(b&&this._listDom[b.isResend?"addClass":"removeClass"]("mod-Message-retryList"),this.config.isDebug){var c=new Airdroid.Module["Test"+this.moduleName];c.createAppView(this)}this.registerWebInterface({addSMSItems:"addSMSItems",setSMSState:"setSMSState",clearAll:"clearAll",setDel:"setDel",smsOperate:"smsOperate"}),this.showLoadingMask(null,!0)},onResize:function(a){},linkClickHandle:function(a){this.util.triggerNavigating(a)},itemClickHandle:function(){return!1},refreshDataHandle:function(){var a=this;a.hideErrorStateTip(),this.showLoadingMask(null,!0),this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.askMessageData.name,time:0,count:10,order:1}))},scrollHandle:function(a,b,c,d){var e=this;if(c&&!e._isLoadingData&&e._hasHistory&&!e.isScrollTriggerAuto()){var f=e._listDom.find(".sms-list-item:first").attr("data-date");e._isLoadingData=f,e.showLoadingFlag(),setTimeout(function(){e.util.triggerPCInterface(JSON.stringify({action:e.pcApi.askMessageData.name,time:f||0,count:10,order:0}))},200)}},resizeItemContent:function(){var a=this._listDom.find(".sms-list-item"),b=a.length-this.MAX_COUNT;if(b>0){var c=a.filter(":eq("+(b+10)+")");c.prevAll(".sms-list-item,.timeline").remove(),this._hasHistory=!0}},hideScrollLoadingMask:function(){var a=this;a._isLoadingData=null,a.hideLoadingFlag()},resizeConWhenAddAfter:function(a,b){this.resizeItemContent(),this.reinitScrollbar(),(a||"1"==b.pop().from)&&this._scrollApi.scrollToBottom(!1)},itemCheckClickHandle:function(a){var b=this,c=$(a.currentTarget),d=c.closest(".sms-list-item");d.hasClass("item-checked")?(d.removeClass("item-checked"),b._delItemArr=_.without(b._delItemArr,d.attr("data-file-id"))):(d.addClass("item-checked"),b._delItemArr.push(d.attr("data-file-id"))),this.util.triggerPCInterface(JSON.stringify({action:b.pcApi.getSelectDelSMSs.name,data:b._delItemArr}))},checkIsCurrentDelState:function(){var a=this;this._isCurrentDelState||(this._listDom.find(".sms-list-item").removeClass("item-checked"),a._delItemArr=[],this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.getSelectDelSMSs.name,data:a._delItemArr}))),this._listDom.find(".sms-list-item .item-checkbox").css("display",this._isCurrentDelState?"inline":"none")},prevSearchHandle:function(a){console.log("sid",$(a.target).attr("data-sid")),this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.askMessageSearchData.name,sid:$(a.target).attr("data-sid")}))},nextSearchHandle:function(a){console.log("sid",$(a.target).attr("data-sid")),this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.askMessageSearchData.name,sid:$(a.target).attr("data-sid")}))},removeItem:function(a){var b=a.prev(".timeline");a.remove(),this.removeTimeline(b)},getItemDom:function(a){return this.find(".sms-list-item[data-file-id='"+a+"']")},addSMSItems:function(a){console.log(JSON.stringify(a)),this._scrollApi.calculateNeedGoBottom();var b=this,c=this._listDom.find(".sms-list-item"),d=0==c.length;if(a.err&&"1"==a.err)return d?b.showErrorStateTip(this.config.ERRORCODE.network):this.util.showDelayMsg($("body"),this.lang.load_msg_fail),b.hideScrollLoadingMask(),!1;var e=a.list;b._hasHistory=e.length>0;var f=parseInt(a.time);if(f&&b._isLoadingData==f&&b.hideScrollLoadingMask(),!(e.length>0))return d?void b.showErrorStateTip(this.config.ERRORCODE.empty):void this.util.showDelayMsg($("body"),this.lang.no_history_sms);b.hideErrorStateTip();var g,h,i,j,k,l=6e4;if(g=a.order.toString()||"1",h="",_.each(e,function(a,i){a=$.extend({},b.defaultOpt,a),j=b.getRelativeDate(e,i,d,c,f),k="0"==g&&0==i&&!b.checkNeedCreateTimeLine(a.date,j,l),h+=b.createTimeline(a.date,j,l,k),a.originBodyText=encodeURIComponent(a.body),a.body=b.util.linkify(a.body.escapeHTML()),h+=b.util.getTemplate("Common","sms_item",{item:a}).trim()}),i=$(h),d||0===f)this._listDom.append(i),this.resizeConWhenAddAfter(d,e);else{var m=c.filter("[data-date='"+f+"']");if("1"==g)m.nextAll(".sms-list-item,.timeline").remove(),m.after(i),this.resizeConWhenAddAfter(d,e);else if("0"==g&&e.length>0){var n=m.prev();n.hasClass("timeline")&&b.checkNeedCreateTimeLine(parseInt(m.attr("data-date")),parseInt(e.pop().date),l)&&(m=n),m.prevAll(".sms-list-item,.timeline").remove(),m.before(i),this.reinitScrollbar(),b._scrollApi.scrollToElement(m,!0)}}a.search&&(b.addSearchToolbar(a.search),b.highlightKeyword(a.search),b.scrollToMsg(a.search)),b.checkIsCurrentDelState(),b.checkLongStrAndBreak(i),setTimeout(function(){b.hanldeWordWrap(i.find(".item-sms-text"),300)},30)},addSearchToolbar:function(a){if(a.sidList&&a.sidList.length>1){var b=$("body");b.addClass("has-search-toolbar");var c=a.sidList||[],d=c.indexOf(a.currSid),e=c[d+1>=c.length?0:d+1],f=c[0>d-1?c.length-1:d-1],g=this.util.getTemplate("Common","search_toolbar",{current:d+1,total:c.length}),h=b.find(".item-search-toolbar"),i=$(g);h.length>0?h.replaceWith(i):b.prepend(i),h=i,h.on("click",".item-btn-prev",_.bind(this.prevSearchHandle,this)),h.on("click",".item-btn-next",_.bind(this.nextSearchHandle,this)),h.find(".item-btn-prev").attr("data-sid",f),h.find(".item-btn-next").attr("data-sid",e),this.setHeaderHeight($(".item-search-toolbar").outerHeight())}},highlightKeyword:function(a){var b,c,d,e,f=this,g=[];a.keyword&&(d=a.keyword,e=(new Date).getTime(),this._refDOM.find(".item-sms-text").each(function(){c=$(this);var h=decodeURIComponent(c.closest(".sms-list-item").attr("data-origin-body"));g=[],d=a.keyword.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),d=d.replace(/%/gi,".*").replace(/_/gi,"."),b=new RegExp(d,"ig"),h=h.replace(b,function(a){return g.push("<strong>"+a+"</strong>"),e+(g.length-1)+e}),h=f.util.linkify(h);for(var i=0;i<g.length;i++)h=h.replace(new RegExp(e+i+e,"g"),g[i]);h=h.replace(/(href=")(\S+)(" target)/gi,function(a,b,c,d){return b+c.replace(/(.*)(<strong>)(.*)(<\/strong>)(.*)/g,"$1$3$5")+d}),c.html(h)}))},scrollToMsg:function(a){if(a.currMsgId){var b=$("#sms_"+a.currMsgId);b.addClass("current-search-target"),this._scrollApi.scrollToElement(b)}},smsOperate:function(a){var b=this,c=a.id;_.isArray(c)||(c=[c]);var d=a.operation;switch(d.toString()){case b.SMS_ACTION.del:_.each(c,function(a){var c=b.getItemDom(a);b.removeItem(c)}),0==b._listDom.find(".sms-list-item").length&&(b._listDom.find(".timeline").remove(),b.showErrorStateTip(b.config.ERRORCODE.empty)),b.reinitScrollbar()}},setSMSState:function(a){var b=a.id,c=a.state,d=this.find(".sms-list-item[data-file-id='"+b+"']"),e=d.attr("class"),f=e.replace(/item-state-[\d]+? {0,1}/g,"item-state-"+c+" ");d.attr("class",f),this.reinitScrollbar()},retrySendSMS:function(a){var b=$(a.currentTarget).parents(".sms-list-item").data("file-id");return this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.smsAction.name,operation:this.pcApi.smsAction.action.resend,id:b})),!1},clearAll:function(){this.setHeaderHeight(0),$("body .item-search-toolbar").remove(),this._listDom.empty(),this.hideErrorStateTip(),this.showLoadingMask(null,!0),this.reinitScrollbar(),this.hideScrollLoadingMask(),this._hasHistory=!0},setDel:function(a){this._isCurrentDelState="1"==a.type,this.checkIsCurrentDelState(),this.reinitScrollbar()}});