Airdroid.Module.TestFeedback=Airdroid.Util.extend(Airdroid.Base,{events:{"click .addFileItems":"addFileItems","click .changedDevice":"changedDevice"},_construct:function(){Airdroid.Util.addPCInterface({triggerPageLoaded:function(a){var b=JSON.parse(a);0===b.isInit&&PC_API("Common_initEnv",{lang:"zh-cn",email:"k11@gmail.com",devices:[{id:"1",name:"5"},{id:"2",name:" meta8"},{id:"3",name:"One Plus"}]})},feedbackFileAction:function(a){a=JSON.parse(a),PC_API("Feedback_fileOperate",{id:a.id,operation:1})},sendFeedback:function(a){a=JSON.parse(a),console.log("sendFeedback"),setTimeout(function(){PC_API("Feedback_showSuccessPage",{id:a.id,operation:1})},3e3)},triggerWebviewResize:function(a){console.log(a)}})},onCreate:function(a){var b=this;this.parentModule=a,this._refDOM=this.containDom=$(b.util.getTemplate("Test",a.moduleName)),a.setTestApiContent(this._refDOM),a.setBodyHeight(460)},changedDevice:function(){PC_API("Feedback_deviceChanged",{deviceList:[{id:"123",name:""},{id:"456",name:"iphone"}]})},addFileItems:function(){var a=[{id:_.uniqueId("attachment_"),name:"12345sdfdsfsdfsdfsdfsdfsdfsdfsdfdfsdfsdfsdfsdfsdf6.txt",size:"521.11kb",state:6}];PC_API("Feedback_addFileItems",{list:a}),PC_API("Feedback_setFileState",{id:a[0].id,state:1});var b=0,c=setInterval(function(){PC_API("Feedback_updateFileProgress",{id:a[0].id,progress:b}),100===b&&(PC_API("Feedback_setFileState",{id:a[0].id,state:3}),clearInterval(c)),b=Math.min(100,b+parseInt(20*Math.random()))},500)}});var AttachmentContainer=Airdroid.Util.extend(Airdroid.Base,{events:{"click .btn-delete":"removeFileItem","click .btn-retry":"retryUpload"},_construct:function(){},onCreate:function(){var a=this;this._refDOM=$(this.util.getTemplate("Common","attachment_container/attachment_container")),("undefined"==typeof this.useScrollbar||this.useScrollbar)&&setTimeout(function(){a._scrollApi_attachment_container=new Airdroid.ScrollBar(a._refDOM,{useJsScroll:!1,animateScroll:!1,mouseWheelSpeed:Airdroid.Util.OS.MacOS?1:50,verticalDragMinHeight:18})},10),this.useShortItem&&this._refDOM.addClass("item-attachment-list-short"),this.shouldTriggerPageLoaded=!1,this.onItemRemove=this.onItemRemove||$.noop,this.onRetryUpload=this.onRetryUpload||$.noop},retryUpload:function(a){var b=$(a.currentTarget).parents("li").attr("id");this.onRetryUpload(b)},setUseShortItem:function(a){this.useShortItem=a},updateAttachmentEmpty:function(){var a=$(".item-attachment-container");this.hasFile()?a.addClass("no-empty"):a.removeClass("no-empty")},getFileCount:function(){return this.getFileDoms().length},getFileDoms:function(){return this._refDOM.find(".item-attachment-list").children()},getFileNames:function(){var a=this.getFileDoms();return 0===a.length?[]:$.map(a,function(a){return $(a).find(".item-file-name").text()})},hasFile:function(){return this.getFileCount()>0},isReady:function(){return this.getUploadingFileCount()<=0},getUploadingFileCount:function(){var a=this._refDOM.find(".item-attachment-list");return a.find(".item-state-1,.item-state-6").length},hasFinishedFile:function(){var a=this._refDOM.find(".item-attachment-list");return a.find(".item-state-3").length>0},addFileItems:function(a){var b=this,c="",d=this._refDOM.find(".item-attachment-list"),e=Airdroid.Util.isRetina()?"../../img/2x/attach_file_watting.png":"../../img/attach_file_watting.png";_.each(a.list,function(a){a.state_icon=e,b.useShortItem?a.shortName=util.omitMiddle(a.name,"...",5,8):a.shortName=util.omitMiddle(a.name),c+=b.util.getTemplate("Common","attachment_container/file_item",a)}),d.append(c),this.updateAttachmentEmpty(),this.reinitScrollbar()},removeFileItem:function(a){a.stopPropagation();var b=$(a.currentTarget).parents("li").attr("id");this.onItemRemove(b),this.reinitScrollbar()},reinitScrollbar:function(){this._scrollApi_attachment_container&&this._scrollApi_attachment_container.reinitialise()},onResize:function(){this.reinitScrollbar()},updateFileProgress:function(a){var b=a.id,c=a.progress;c=Math.max(c,2),c=Math.min(c,100),$("#"+b).find(".item-file-progress").css("width",c+"%")},setFileState:function(a){var b=a.id,c=a.state,d=$(".item-attachment-list").children(),e=d.filter("#"+b);e.removeClass("item-state-6").removeClass("item-state-1").removeClass("item-state-2").removeClass("item-state-3").addClass("item-state-"+c);var f=e.find(".item-state-icon"),g=Airdroid.Util.isRetina()?"../../img/2x":"../../img";switch(c.toString()){default:case"1":f.attr("src",g+"/attach_file_ing.png");break;case"2":f.attr("src",g+"/attach_file_failed.png");break;case"3":f.attr("src",g+"/attach_file_success.png");break;case"6":f.attr("src",g+"/attach_file_watting.png")}},updateFileSpeed:function(a){var b=a.id,c=a.speed;$("#"+b).find(".item-file-speed").text("("+c+")")},fileOperate:function(a){var b=a.id,c=a.operation;1==c&&($("#"+b).remove(),this.updateAttachmentEmpty())},show:function(){this._refDOM.show()},hide:function(){this._refDOM.hide()},clearAll:function(){$(".item-attachment-list").empty(),this.updateAttachmentEmpty(),this.reinitScrollbar(),this._scrollApi_attachment_container&&this._scrollApi_attachment_container._refDOM.scrollTop(0)}});window.util.isValidEmail=function(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)},Airdroid.Module.Feedback=Airdroid.Util.extend(Airdroid.Base,{moduleName:Airdroid.Config.Module.Feedback,events:{"submit #feedback_form":"submit","click #submit_btn":"submit","click .item-help":"goHelp","click #mailto":"mailto","click .feedback-success-container ol li a":"openPage","click .btn-upload-image":"openFileDialog","click .btn-write-another":"onClickAnotherQuestion","click .btn-close":"close","change #topic":"onTopicChange"},useOriginScrollbar:!0,_construct:function(){},onCreate:function(){var a=this;this.lang=Airdroid.Lang,this._refDOM=$(a.util.getTemplate("Feedback","index")),this.setContent(this._refDOM,{noScroll:!0}),this.disableResize();var b=this.util.getEnv(),c=$("#email");b&&c.val(b.email||""),this.setSelectDevices(b&&b.devices);var d=this.attachmentContainer=new AttachmentContainer;if(d.useScrollbar=!1,d.onItemRemove=function(b){a.util.triggerPCInterface(JSON.stringify({action:a.pcApi.feedbackFileAction.name,operation:a.pcApi.feedbackFileAction.action.del,id:b})),d.hasFile()||d.hide(),a.updateSubmitButtonState(),a.triggerWebviewResize()},d.onRetryUpload=function(b){a.util.triggerPCInterface(JSON.stringify({action:a.pcApi.feedbackFileAction.name,operation:a.pcApi.feedbackFileAction.action.restartUpload,id:b})),d.hasFile()||d.hide(),a.updateSubmitButtonState(),a.triggerWebviewResize()},d.setUseShortItem(!0),d.createAppView(this),this._refDOM.find(".item-feedback-attachment").append(d._refDOM),this.config.isDebug){var e=new Airdroid.Module["Test"+this.moduleName];e.createAppView(this)}this.registerWebInterface({addFileItems:"addFileItems",updateFileProgress:"updateFileProgress",updateFileSpeed:"updateFileSpeed",setFileState:"setFileState",showSuccessPage:"showSuccessPage",showFailTip:"showFailTip",fileOperate:"fileOperate",deviceChanged:"deviceChanged"})},onCreated:function(){this._refDOM.css("height","auto"),$("#upload_log").prop("checked",!0),this.triggerWebviewResize()},onTopicChange:function(a){var b=$("#upload_log_container"),c=$("#upload_log"),d=$("#content"),e=$(".select-container-device"),f=$(a.target).val();return 3==f?(!e.hasClass("select-no-device")&&Airdroid.Util.enableDom(e),d.attr("placeholder",this.lang.feedback_device_tip),b.show(),c.prop("checked",!0)):(Airdroid.Util.disableDom(e),d.attr("placeholder",this.lang.input_tip),b.hide(),c.prop("checked",!1)),!1},setSelectDevices:function(a){var b=this;a=a||[];var c=$(".row-question-device"),d=c.find(".select-container-device"),e=$(".item-help");0==a.length?(c.hide(),d.addClass("select-no-device"),e.appendTo(".row-question-type .select-container-topic")):(c.show(),d.removeClass("select-no-device"),e.appendTo(d));var f=$("#selectDevice");f.html(b.util.getTemplate("Feedback","select_device_item",{data:[{id:"-1",name:b.lang.feedback_device_default}].concat(a)}).trim())},submit:function(a){a.preventDefault();var b=this,c=$("#email"),d=$("#topic"),e=$("#submit_btn"),f=$("#content"),g=$("#upload_log"),h=$("#selectDevice"),i=$(".select-container-device"),j=$("html").hasClass("lt-ie9");this.attachmentContainer.hasFile();if(!e.hasClass("btn-disabled")){var k=(Airdroid.Util.getParam("q"),c.val().trim()),l=f.val(),m=h.val(),n=d.val();if(""==k)return b.showTip("error",b.lang.empty_email),!1;if(!util.isValidEmail(k))return b.showTip("error",b.lang.invalid_email),!1;if(""==l.replace(/\s/g,"")||j&&(l==b.lang.input_tip||l==b.lang.feedback_device_tip))return b.showTip("error",b.lang.empty_content),!1;if(l.replace(/^\s+|\s+$/g,"").length<10)return b.showTip("error",b.lang.too_short),!1;var o=b.attachmentContainer.getFileNames().join(",");if(l+o+m+n===b.last_commit)return b.showTip("error",b.lang.repeat_commit),!1;b.last_commit=l+o+m+n,b.clearTip(),b.disableButton(e),b.isLoading=!0,this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.sendFeedback.name,feedbackType:n,content:l,email:k,deviceId:3!=n||i.hasClass("select-no-device")?-1:m,uploadLog:g.prop("checked")?"1":"0",lang:Airdroid.local||"en"}))}},openFileDialog:function(){return this.attachmentContainer.getFileCount()>=3?void this.showTip("error",this.lang.fail_image_limit):void this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.triggerActive.name,operation:this.pcApi.triggerActive.action.openFileDialog}))},goHelp:function(a){$(a.target).hasClass("item-success-help")?this.util.trackEvent("click__success_help"):this.util.trackEvent("click__form_help"),this.util.triggerNavigating("http://forums.airdroid.com/viewtopic.php?f=4&t=16397",a)},openPage:function(a){a.preventDefault(),this.util.trackEvent("click__"+a.target.id),this.util.triggerNavigating(a)},mailto:function(a){this.util.triggerNavigating("mailto:support@airdroid.com",a)},onResize:function(a){},showTip:function(a,b){var c=$("#tip");c.attr("class",a),c.text(b)},clearTip:function(){var a=$("#tip");a.attr("class",""),a.text(""),this.triggerWebviewResize()},disableButton:function(a){a.prop("disabled",!0),a.addClass("btn-disabled"),a.css("color","#CCCCCC")},enableButton:function(a){a.prop("disabled",!1),a.removeClass("btn-disabled"),a.css("color","#666666")},onClickAnotherQuestion:function(){this.util.trackEvent("click__another_question"),this.showFeedbackForm()},showFeedbackForm:function(){$(".feedback-container").removeClass("hide"),$(".feedback-success-container").addClass("hide"),this.triggerWebviewResize()},clearFeedbackForm:function(){var a=$("#topic");a.val(3),a.trigger("change"),$("#content").val(""),$("#upload_log_container").show(),$("#upload_log").prop("checked",!0),this.attachmentContainer.clearAll(),this.attachmentContainer.hide()},updateSubmitButtonState:function(){var a=$("#submit_btn");this.attachmentContainer.isReady()&&!this.isLoading?this.enableButton(a):this.disableButton(a)},close:function(){this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.triggerActive.name,operation:this.pcApi.triggerActive.action.close}))},triggerWebviewResize:function(){var a=this;setTimeout(function(){a.util.triggerPCInterface(JSON.stringify({action:a.pcApi.triggerWebviewResize.name,width:a._refDOM.outerWidth(),height:a._refDOM.outerHeight()}))},1)},showSuccessPage:function(){$(".feedback-container").addClass("hide"),3==$("#topic").val()?$(".feedback-success-type-issue").removeClass("hide"):$(".feedback-success-type-other").removeClass("hide"),this.clearFeedbackForm(),this.isLoading=!1,this.enableButton($("#submit_btn")),this.triggerWebviewResize()},showFailTip:function(a){switch(a=a||{},parseInt(a.code)){case-1:this.showTip("error",this.lang.repeat_commit);break;case-2:Airdroid.Util.showDelayMsg(this._refDOM,this.lang.file_already_exists);break;default:this.showTip("error",this.lang.failure)}this.last_commit="",this.enableButton($("#submit_btn")),this.triggerWebviewResize()},addFileItems:function(a){this.attachmentContainer.addFileItems(a),this.attachmentContainer.hasFile()&&this.attachmentContainer.show(),this.updateSubmitButtonState(),this.triggerWebviewResize()},setFileState:function(a){this.attachmentContainer.setFileState(a),this.updateSubmitButtonState()},updateFileProgress:function(a){this.attachmentContainer.updateFileProgress(a),this.updateSubmitButtonState()},updateFileSpeed:function(a){this.attachmentContainer.updateFileSpeed(a)},fileOperate:function(a){this.attachmentContainer.fileOperate(a),this.updateSubmitButtonState()},deviceChanged:function(a){this.setSelectDevices(a.deviceList),$("#topic").trigger("change")}});