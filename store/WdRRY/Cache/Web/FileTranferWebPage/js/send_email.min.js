Airdroid.Module.TestSendEmail=Airdroid.Util.extend(Airdroid.Base,{events:{"click .addFileItems":"addFileItems","click .setFileState2":"setFileState2"},defaultOpt:{},defaultContactArr:[],_construct:function(){var a=this;Airdroid.Util.addPCInterface({triggerPageLoaded:function(a){var b=JSON.parse(a);0===b.isInit&&PC_API("Common_initEnv",{lang:"fr"})},sendEmail:function(a){alert(JSON.stringify(a)),PC_API("SendEmail_clearAll")},clearEmailFile:function(){PC_API("SendEmail_clearAll")},emailFileAction:function(b){b=JSON.parse(b),b.operation==a.pcApi.emailFileAction.action.del?PC_API("SendEmail_fileOperate",{id:b.id,operation:1}):b.operation==a.pcApi.emailFileAction.action.restartUpload&&PC_API("SendEmail_setFileState",{id:"attachment_1",state:6})},askContactData:function(){setTimeout(function(){PC_API("SendEmail_getContactData",{list:a.defaultContactArr,err:0}),a.isError+=1},100)},getSelectContacts:function(b){console.log(b);var c=JSON.parse(b);a._selectContacts=c}})},onCreate:function(a){var b=this;this.parentModule=a,this._refDOM=this.containDom=$(b.util.getTemplate("Test",a.moduleName)),a.setTestApiContent(this._refDOM),b.createContactData()},createContactData:function(){for(var a=this,b=0;50>b;b++)a.defaultContactArr.push({id:a.getUniqId(),name:_.uniqueId("helloxxxxxxxxxxx"),email:_.uniqueId("user")+"@test.com",type:"work"});a.defaultContactArr.push({id:a.getUniqId(),name:"-",email:_.uniqueId("user")+"@test.com",type:"Custom"}),a.defaultContactArr.push({id:a.getUniqId(),name:'12<script>alert("223");</script>',email:"zhuangzhuang66+airdroid@airdroid.com",type:"work"}),a.defaultContactArr.push({id:a.getUniqId(),name:'#"><img src=x onerror=prompt(document.cookie)/>',email:_.uniqueId("user")+"@test.com",type:"work"})},getUniqId:function(){return Math.floor(1e7*Math.random())},addFileItems:function(){var a=[{id:_.uniqueId("attachment_"),name:"12345sdfdsfsdfsdfsdfsdfsdfsdfsdfdfsdfsdfsdfsdfsdf6.txt",size:"52kb",state:6}];PC_API("SendEmail_addFileItems",{list:a}),PC_API("SendEmail_setFileState",{id:a[0].id,state:1});var b=0,c=setInterval(function(){PC_API("SendEmail_updateFileProgress",{id:a[0].id,progress:b}),100===b&&(PC_API("SendEmail_setFileState",{id:a[0].id,state:3}),clearInterval(c)),b=Math.min(100,b+parseInt(20*Math.random()))},500)},setFileState2:function(){PC_API("SendEmail_setFileState",{id:"attachment_1",state:2})}});var ContactSelector=Airdroid.Util.extend(Airdroid.Base,{_contact_sepatators:[","," ",";","，","　","；"],events:{"keyup .inputbar-input":"contactInputKeyUpHandle","keydown .inputbar-input":"contactInputKeyDownHandle","blur .inputbar-input":"contactInputBlurHandle","keydown .inputbar-con":"inputConKeyDownHandle","click .inputbar-con":"inputConClickHandle","mouseenter .mod-ContactSelector-inputFloatPane .select-item":"selectItemMouseEnterHandle","mouseenter .mod-ContactSelector-contactFloatList .select-item":"contactItemMouseEnterHandle","click .mod-ContactSelector-inputFloatPane .select-item":"floatSelectHandle","click .mod-ContactSelector-contactFloatList .select-item":"contactSelectHandle","click .mod-ContactSelector-inputbar .inputbar-add":"showContactSelectHandle","click .mod-ContactSelector-contactFloatPaneContainer":"contactPaneClickHandle","keyup .mod-ContactSelector-searchInput":"contactSearchKeyUpHandle","click .inputbar-select":"inputSelectClickHandle","blur .inputbar-select":"inputSelectBlurHandle",click:"moduleClickHandle",keyup:"moduleKeyUpHandle","keydown .mod-ContactSelector-contactFloatPaneContainer":"ContactPaneKeyDownHandle","click .btn-delete-revice-item":"onDeleteReviceItemClick","click .item-refresh":"refreshDataHandle","click .mod-ContactSelector-inputFloatPaneContainer":"floatPaneClickHandle","click .icon-clear":"clickClearHandle","focus input":"ieBlurCursorPositionFix","blur input":"ieBlurCursorPositionFix"},_sendContactObj:{},_checkContactPaneLoad:!1,_hasFormatContact:!1,_contactSearchTimer:null,_construct:function(){},onCreate:function(){var a=this;this._refDOM&&this._refDOM.empty(),this._refDOM=$(a.util.getTemplate("Common","contact_selector/contact_selector")),this._refDOM.find(".mod-ContactSelector-inputFloatPaneContainer").css("position","absolute"),this.containDom=this._refDOM,a._dom={contactInputDom:a.find(".inputbar-con"),contactInput:a.find(".inputbar-inputItem"),selectFloatPane:a.find(".mod-ContactSelector-inputFloatPane"),selectFloatPaneContainer:a.find(".mod-ContactSelector-inputFloatPaneContainer"),contactFloatPaneContainer:a.find(".mod-ContactSelector-contactFloatPaneContainer"),contactFloatListContainer:a.find(".mod-ContactSelector-contactFloatListContainer"),inputBar:a.find(".mod-ContactSelector-inputbar"),contactFloatList:a.find(".mod-ContactSelector-contactFloatList"),contactSearchInput:a.find(".mod-ContactSelector-searchInput"),contactSearchInputCon:a.find(".mod-ContactSelector-searchInputCon"),contactClearBtn:a.find(".icon-clear")},this._scrollApi_attachment_container=new Airdroid.ScrollBar(a._dom.selectFloatPaneContainer,{useJsScroll:!0,animateScroll:!1,mouseWheelSpeed:Airdroid.Util.OS.MacOS?1:50,verticalDragMinHeight:18}),this._scrollApi_contact=new Airdroid.ScrollBar(a._dom.contactFloatListContainer,{useJsScroll:!0,animateScroll:!1,mouseWheelSpeed:Airdroid.Util.OS.MacOS?1:50,verticalDragMinHeight:18}),a._dom.contactInputDom.append(a.util.getTemplate("Common","contact_selector/select_input_item").trim()),this._curr_suggest_val="",this._curr_contact_val="",this.shouldTriggerPageLoaded=!1,a.contactData=[],a.showLoadingMask(this._dom.contactFloatPaneContainer),setTimeout(function(){a.askContactData()},1e3)},setRefDOM:function(a){this._refDOM=a},askContactData:function(){var a=this;this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.askContactData.name}))},selectContact:function(a){var b=this,c=[];_.each(this.contactData,function(d){"phone"===b.getContactType()?(d.name.toLowerCase().indexOf(a)>-1||d.phone.toString().indexOf(a)>-1)&&c.push(d):"email"===b.getContactType()&&(d.name.toLowerCase().indexOf(a)>-1||d.email.toString().indexOf(a)>-1)&&c.push(d)}),c.length>0?this.showSelectFloatPane(c):this.hideSelectFloatPane()},showSelectFloatPane:function(a){this._dom.selectFloatPane.html(this.util.getTemplate("Common","contact_selector/select_pane_item",{contactItems:a}).trim()),this._dom.selectFloatPaneContainer.removeClass("hide");var b=50*a.length+1,c=this.util.checkIsIE()?b+10:b,d=b>401;this._dom.selectFloatPaneContainer[d?"addClass":"removeClass"]("mod-ContactSelector-inputFloatPaneContainer-border"),this._dom.selectFloatPaneContainer.height(d?401:c).css("top",this._dom.inputBar.height()+"px"),this._scrollApi_attachment_container.reinitialise()},hideSelectFloatPane:function(){this._dom.selectFloatPane.empty(),this._dom.selectFloatPaneContainer.addClass("hide")},showContactFloatPane:function(){this._dom.contactFloatPaneContainer.removeClass("hide")},hideContactFloatPane:function(){this._dom.contactFloatPaneContainer.addClass("hide")},getContactDom:function(a){return"phone"===this.getContactType()?this._dom.contactInputDom.find(".inputbar-select[data-phone='"+a.phone+"']"):this._dom.contactInputDom.find(".inputbar-select[data-email='"+a.email+"']")},floatSelectHandle:function(a){var b,c=this,d=$(a.currentTarget),e=c.getDomContactParam(d),f=e.name,g=e.phone,h=e.email;if(b=this.getContactDom(e),0==b.length){var i={name:f,email:h,phone:g,id:e.id};c.addRecipientContact(i)}else c.setInputDomFocus();return c.hideSelectFloatPane(),!1},contactSelectHandle:function(a){var b=this,c=$(a.currentTarget),d=b.getDomContactParam(c),e=d.name,f=d.phone,g=d.id,h=d.email,i=this.getContactDom(d),j=i.length>0;b.util.toggleChecked(c.find(".checkbox").parents(".select-item"),function(){!j&&b.addRecipientContact({name:e,phone:f,email:h,id:g})},function(){j&&b.deleteRecipientContact(i)})},inputSelectClickHandle:function(a){var b=this,c=$(a.currentTarget);return b._dom.contactInputDom.find(".inputbar-select").removeClass("selected"),c.addClass("selected").attr("tabindex",0).focus(),b.moduleClickHandle(),!1},inputSelectBlurHandle:function(a){$(a.currentTarget).removeClass("selected").removeAttr("tabindex")},changContactSelectStatus:function(a){var b=this._dom.contactFloatListContainer.find('.select-item[data-id="'+a.id+'"]');return"phone"===this.getContactType()?b.filter("[data-phone='"+a.phone+"']").trigger("click"):b.filter("[data-email='"+a.email+"']").trigger("click")},createContactPane:function(a){var b=this;a=a||b.contactData;var c=b.contactData.length;c>0&&!this._checkContactPaneLoad&&(this._dom.contactFloatList.html(this.util.getTemplate("Common","contact_selector/contact_pane_item",{contactItems:a}).trim()),this._checkContactPaneLoad=!0,_.each(this._sendContactObj,function(a){a.id&&b.changContactSelectStatus(a)}),a.length>0?b.hideContactErrorStateTip(!0):b.showContactErrorStateTip(this.config.ERRORCODE.empty,!0))},refreshDataHandle:function(){var a=this;a.hideContactErrorStateTip(),a.showLoadingMask(this._dom.contactFloatPaneContainer),a.askContactData()},showContactSelectHandle:function(a,b){var c=this;return this._dom.contactFloatPaneContainer.hasClass("hide")||b?(c.createContactPane(),this.showContactFloatPane(),this._scrollApi_contact.reinitialise()):this.hideContactFloatPane(),!1},contactPaneClickHandle:function(){return this.hideSelectFloatPane(),this._dom.contactSearchInput.focus(),!1},inputConClickHandle:function(){var a=$(".inputbar-inputItem");a.find(".inputbar-input").focus()},floatPaneClickHandle:function(a){return!1},moduleClickHandle:function(){this.hideContactFloatPane(),this.hideSelectFloatPane()},clickClearHandle:function(){this._dom.contactSearchInput.val("").trigger("keyup")},setInputDomFocus:function(){var a=this,b=a._dom.contactInputDom.find(".inputbar-input");b.val("").trigger("keyup"),document.activeElement==b.get(0)&&b.focus()},moduleKeyUpHandle:function(a){var b=this;switch(a.keyCode){case b.util.keyCode.BACKSPACE:case b.util.keyCode.DEL:var c=b._dom.contactInputDom.find(".inputbar-select.selected");c.length>0&&b.deleteRecipientContact(c)}return!1},contactInputKeyUpHandle:function(a){var b=this,c=$(a.currentTarget),d=c.val().trim().toLowerCase();return b._curr_suggest_val!==d&&(c.parent().find(".inputbar-inputVal").html(d),b._curr_suggest_val=d,0==d.length?this.hideSelectFloatPane():b.selectContact(d)),!1},contactSearchKeyUpHandle:function(a){var b=this,c=$(a.currentTarget),d=c.val().trim().toLowerCase();if(b._curr_contact_val!==d){b._curr_contact_val=d;var e=[];b._contactSearchTimer&&clearTimeout(b._contactSearchTimer),b._contactSearchTimer=setTimeout(function(){d.length>0?(_.each(b.contactData,function(a){var c="";"phone"===b.getContactType()?c=a.phone.toString():"email"===b.getContactType()&&(c=a.email),(a.name.toLowerCase().indexOf(d)>-1||c.indexOf(d)>-1)&&e.push(a)}),b._checkContactPaneLoad=!1,b.createContactPane(e)):(b._checkContactPaneLoad=!1,b.createContactPane()),b._scrollApi_contact.reinitialise()},50)}b._dom.contactClearBtn[""==d?"addClass":"removeClass"]("hide")},deleteRecipientContact:function(a,b,c){for(var d=this,e=d._dom.contactInputDom,f=d.getDomContactParam(a),g=e.get(0).childNodes,h=-1,i=0,j=g.length;j>i;i++)if(g[i]==a.get(0)){h=i;break}var k=g[h];k.parentNode.removeChild(k),d.changeSendContact("delete",f,b,c)},moveInputDom:function(a,b){var c=this,d=null;if("left"==b?d=a.prev(".revice-item"):"right"==b&&(d=a.next(".revice-item")),d.length>0&&0==c._curr_suggest_val.length){var e=d.clone();d.remove(),"left"==b?a.after(e):"right"==b&&a.before(e)}},contactInputKeyDownHandle:_.throttle(function(a){var b=this,c=$(a.currentTarget),d=c.parent();switch(a.keyCode){case b.util.keyCode.BACKSPACE:if(0==c.val().trim().length){var e=d.prev(".revice-item");e.length>0&&b.deleteRecipientContact(e)}break;case b.util.keyCode.LEFT:b.moveInputDom(d,"left");break;case b.util.keyCode.RIGHT:b.moveInputDom(d,"right")}},100),getDomContactParam:function(a){return{id:a.attr("data-id").trim(),phone:a.attr("data-phone"),email:a.attr("data-email"),name:a.attr("data-name").trim()||a.attr("data-email")||a.attr("data-phone").trim()}},selectItemMouseEnterHandle:function(a){var b=this,c=$(a.currentTarget);return b._dom.selectFloatPane.find(".select-item").removeClass("suggest-hover"),c.addClass("suggest-hover"),!1},contactItemMouseEnterHandle:function(a){var b=this,c=$(a.currentTarget);return b._dom.contactFloatListContainer.find(".select-item").removeClass("suggest-hover"),c.addClass("suggest-hover"),!1},changeSendContact:function(a,b,c,d){var e=this,f="phone";switch("phone"===this.getContactType()?f=b.phone:"email"===this.getContactType()&&(f=b.email),a){case"add":e._sendContactObj[f]=b,this.onAddRecipient&&this.onAddRecipient();break;case"delete":delete e._sendContactObj[f],this.onRemoveRecipient&&this.onRemoveRecipient()}(d||e._dom.contactFloatPaneContainer.hasClass("hide"))&&b.id&&e.changContactSelectStatus(b),this._dom.contactFloatPaneContainer.css("top",""),c||this.pushSelectContactToPC()},addRecipientContact:function(a,b){var c=this;a.id=a.id||"";for(var d=c._dom.contactInputDom,e=this.util.getTemplate("Common","contact_selector/select_selected_item",{item:a}),f=d.get(0).childNodes,g=d.find(".inputbar-inputItem").get(0),h=-1,i=[],j=0,k=f.length;k>j;j++)f[j]==g?h=j:h>=0&&i.push(f[j].cloneNode(!0));if(-1==h)d.append($(e));else{for(f[h].parentNode.replaceChild($(e).get(0),f[h]);f[h+1];)f[h].parentNode.removeChild(f[h+1]);var l=$(c.util.getTemplate("Common","contact_selector/select_input_item"));d.get(0).appendChild(l.get(0));for(var m=0;m<i.length;m++)d.get(0).appendChild(i[m]);c.setInputDomFocus()}c._curr_suggest_val="",c.changeSendContact("add",a,b)},getContactType:function(){return this._contactType||"phone"},setContactType:function(a){this._contactType=a},addRecipientWhenNoExist:function(a){var b,c=this;if("phone"===this.getContactType()){if(c.util.checkPhoneNumberMatch(a)){var b=c._dom.contactInputDom.find(".inputbar-select[data-phone='"+a+"']");return void(0==b.length?c.addRecipientContact({name:a,phone:a,id:""}):c.setInputDomFocus())}}else if("email"===this.getContactType()&&util.isValidEmail(a))return b=c._dom.contactInputDom.find(".inputbar-select[data-email='"+a+"']"),void(0==b.length?c.addRecipientContact({name:a,email:a,id:""}):c.setInputDomFocus());return c.setInputDomFocus()},addRevictor:function(a){var b=this,c="";0==b.contactData.length?b.addRecipientWhenNoExist(a):_.each(b.contactData,function(d){if((d.phone==a||d.email==a||d.name.toLowerCase()==a.toLowerCase())&&(c=d),c){var e=b.getContactDom(c);0==e.length?b.addRecipientContact({name:c.name,phone:c.phone,email:c.email,id:c.id}):b.setInputDomFocus()}else b.addRecipientWhenNoExist(a)})},formatRecipient:function(){var a=this,b=a._curr_suggest_val.trim(),c=",";if(0==b.length)return!1;for(var d=a._contact_sepatators.length-1;d>=0;d--)if(b.indexOf(a._contact_sepatators[d])>=0){c=a._contact_sepatators[d];break}for(var e=b.split(c),f=[],d=0;d<e.length;d++)""!=e[d].trim()&&f.push(e[d]);if(1==f.length){var g=a._dom.selectFloatPane.find(".suggest-hover");g.length>0?(g.trigger("click"),a.hideSelectFloatPane()):a.addRevictor(f[0])}else f.length>0&&(a.hideSelectFloatPane(),_.each(f,function(b){a.addRevictor(b.trim())}))},inputConKeyDownHandle:function(a){var b=this;$(a.currentTarget);switch(a.keyCode){case b.util.keyCode.UP:a.preventDefault();var c=b._dom.selectFloatPane.find(".suggest-hover").prev();0==c.length&&(c=b._dom.selectFloatPane.find(".select-item:last")),c.length>0&&(c.trigger("mouseenter"),b._scrollApi_attachment_container.scrollToElement(c,!1,!0));break;case b.util.keyCode.DOWN:a.preventDefault();var c=b._dom.selectFloatPane.find(".suggest-hover").next();0==c.length&&(c=b._dom.selectFloatPane.find(".select-item:first")),c.length>0&&(c.trigger("mouseenter"),b._scrollApi_attachment_container.scrollToElement(c,!1,!0));break;case b.util.keyCode.TAB:case b.util.keyCode.SPACE:case b.util.keyCode.RETURN:b._hasFormatContact=!0,b.formatRecipient(),b.util.checkIsIE()&&b.doInputBlurHandle()}return a.keyCode==b.util.keyCode.RETURN||a.keyCode==b.util.keyCode.SPACE?(setTimeout(function(){b._dom.contactInputDom.trigger("click")},50),!1):!0},ContactPaneKeyDownHandle:function(a){var b=this,c=($(a.currentTarget),b._dom.contactFloatList.find(".select-item")),d=[];switch(a.keyCode){case b.util.keyCode.UP:a.preventDefault(),0==c.filter(".suggest-hover").length?d=c.filter(":last"):(d=b._dom.contactFloatList.find(".suggest-hover").prev(),0==d.length&&(d=b._dom.contactFloatList.find(".select-item:last"))),d.length>0&&(d.trigger("mouseenter"),b._scrollApi_contact.scrollToElement(d,!1,!0));break;case b.util.keyCode.DOWN:a.preventDefault(),0==c.filter(".suggest-hover").length?d=c.filter(":first"):(d=b._dom.contactFloatList.find(".suggest-hover").next(),0==d.length&&(d=b._dom.contactFloatList.find(".select-item:first"))),d.length>0&&(d.trigger("mouseenter"),b._scrollApi_contact.scrollToElement(d,!1,!0));break;case b.util.keyCode.TAB:case b.util.keyCode.SPACE:case b.util.keyCode.RETURN:d=c.filter(".suggest-hover"),d.length>0&&(d.trigger("click"),setTimeout(function(){b._dom.contactInputDom.find(".inputbar-input").blur(),b._dom.contactSearchInput.focus()},50))}return!0},onDeleteReviceItemClick:function(a){var b=$(a.target).parent(".inputbar-select");b.length>0&&this.deleteRecipientContact(b,null,!0)},doInputBlurHandle:function(){var a=this;a.util.checkIsIE()&&a._dom.selectFloatPaneContainer.is(":visible")&&(a._hasFormatContact=!0),a._hasFormatContact?a._hasFormatContact=!1:0!=a._curr_suggest_val.length&&(a.hideSelectFloatPane(),a.formatRecipient())},contactInputBlurHandle:function(a){var b=this,c=$(".inputbar-input");b._curr_suggest_val=c.val().trim(),setTimeout(function(){b.doInputBlurHandle()},200)},pushSelectContactToPC:function(){if("email"!==this.getContactType()){var a=this;_.isObject(a._sendContactObj)&&this.util.triggerPCInterface(JSON.stringify({action:a.pcApi.getSelectContacts.name,data:_.values(a._sendContactObj)}))}},getRecipients:function(){return _.toArray(this._sendContactObj)},ieBlurCursorPositionFix:function(a){var b=a.target;if(b.value=$.trim(b.value),"focus"===a.type||"focusin"===a.type)if("number"==typeof b.selectionStart)b.selectionStart=b.selectionEnd=b.value.length;else if("undefined"!=typeof b.createTextRange){b.focus();var c=b.createTextRange();c.collapse(!1),c.select()}},getContactData:function(a){var b=this,c=a.list,d=this.getContactType();return b.contactData.length=0,console.log(a.list),c=_.filter(c,function(a){return"phone"==d?a.phone:a.email}),"email"==d&&_.each(c,function(a){a.shortEmail=util.omitMiddle(a.email,"...",6,15)}),b.contactData=c,a.err&&"1"==a.err?(b.showContactErrorStateTip(this.config.ERRORCODE.network),!1):(this.contactData.length>0?b.hideContactErrorStateTip(!0):(this._dom.contactFloatList.html(""),b.showContactErrorStateTip(this.config.ERRORCODE.empty),this._scrollApi_contact.reinitialise()),b._checkContactPaneLoad=!1,void(this._dom.contactFloatPaneContainer.is(":visible")&&this.showContactSelectHandle(null,!0)))},showContactErrorStateTip:function(a,b){this._dom.contactSearchInputCon[b?"removeClass":"addClass"]("i-visibility-hide"),this.showErrorStateTip(a,this._dom.contactFloatPaneContainer)},hideContactErrorStateTip:function(a){this._dom.contactSearchInputCon[a?"removeClass":"addClass"]("i-visibility-hide"),this.hideErrorStateTip(this._dom.contactFloatPaneContainer)},showSendSMSItem:function(a){var b={body:a.body,cid:"",date:a.date,from:"1",icon:"../../img/contact_avatar.png",id:"",state:1,to:a.to,type:"0"};this.find(".mod-ContactSelector-smsCon").append(this.util.getTemplate("Common","sms_item",{item:b}).trim())},addRecipient:function(a){var b=this;_.isArray(a)&&a.length>0&&(_.each(a,function(a){var c=b.getContactDom(a);0==c.length&&b.addRecipientContact({name:a.name,phone:a.phone,id:a.id},!0)}),this.pushSelectContactToPC())},clearAll:function(){var a=this;this._dom.contactInputDom.find(".inputbar-select").remove(),a._sendContactObj={},this.find(".mod-ContactSelector-smsCon").empty(),this.moduleClickHandle(),a._checkContactPaneLoad=!1,this._dom.contactFloatList.html(""),this._dom.contactFloatPaneContainer.css("top",""),a._dom.contactSearchInput.val("").trigger("keyup")}}),AttachmentContainer=Airdroid.Util.extend(Airdroid.Base,{events:{"click .btn-delete":"removeFileItem","click .btn-retry":"retryUpload"},_construct:function(){},onCreate:function(){var a=this;this._refDOM=$(this.util.getTemplate("Common","attachment_container/attachment_container")),("undefined"==typeof this.useScrollbar||this.useScrollbar)&&setTimeout(function(){a._scrollApi_attachment_container=new Airdroid.ScrollBar(a._refDOM,{useJsScroll:!1,animateScroll:!1,mouseWheelSpeed:Airdroid.Util.OS.MacOS?1:50,verticalDragMinHeight:18})},10),this.useShortItem&&this._refDOM.addClass("item-attachment-list-short"),this.shouldTriggerPageLoaded=!1,this.onItemRemove=this.onItemRemove||$.noop,this.onRetryUpload=this.onRetryUpload||$.noop},retryUpload:function(a){var b=$(a.currentTarget).parents("li").attr("id");this.onRetryUpload(b)},setUseShortItem:function(a){this.useShortItem=a},updateAttachmentEmpty:function(){var a=$(".item-attachment-container");this.hasFile()?a.addClass("no-empty"):a.removeClass("no-empty")},getFileCount:function(){return this.getFileDoms().length},getFileDoms:function(){return this._refDOM.find(".item-attachment-list").children()},getFileNames:function(){var a=this.getFileDoms();return 0===a.length?[]:$.map(a,function(a){return $(a).find(".item-file-name").text()})},hasFile:function(){return this.getFileCount()>0},isReady:function(){return this.getUploadingFileCount()<=0},getUploadingFileCount:function(){var a=this._refDOM.find(".item-attachment-list");return a.find(".item-state-1,.item-state-6").length},hasFinishedFile:function(){var a=this._refDOM.find(".item-attachment-list");return a.find(".item-state-3").length>0},addFileItems:function(a){var b=this,c="",d=this._refDOM.find(".item-attachment-list"),e=Airdroid.Util.isRetina()?"../../img/2x/attach_file_watting.png":"../../img/attach_file_watting.png";_.each(a.list,function(a){a.state_icon=e,b.useShortItem?a.shortName=util.omitMiddle(a.name,"...",5,8):a.shortName=util.omitMiddle(a.name),c+=b.util.getTemplate("Common","attachment_container/file_item",a)}),d.append(c),this.updateAttachmentEmpty(),this.reinitScrollbar()},removeFileItem:function(a){a.stopPropagation();var b=$(a.currentTarget).parents("li").attr("id");this.onItemRemove(b),this.reinitScrollbar()},reinitScrollbar:function(){this._scrollApi_attachment_container&&this._scrollApi_attachment_container.reinitialise()},onResize:function(){this.reinitScrollbar()},updateFileProgress:function(a){var b=a.id,c=a.progress;c=Math.max(c,2),c=Math.min(c,100),$("#"+b).find(".item-file-progress").css("width",c+"%")},setFileState:function(a){var b=a.id,c=a.state,d=$(".item-attachment-list").children(),e=d.filter("#"+b);e.removeClass("item-state-6").removeClass("item-state-1").removeClass("item-state-2").removeClass("item-state-3").addClass("item-state-"+c);var f=e.find(".item-state-icon"),g=Airdroid.Util.isRetina()?"../../img/2x":"../../img";switch(c.toString()){default:case"1":f.attr("src",g+"/attach_file_ing.png");break;case"2":f.attr("src",g+"/attach_file_failed.png");break;case"3":f.attr("src",g+"/attach_file_success.png");break;case"6":f.attr("src",g+"/attach_file_watting.png")}},updateFileSpeed:function(a){var b=a.id,c=a.speed;$("#"+b).find(".item-file-speed").text("("+c+")")},fileOperate:function(a){var b=a.id,c=a.operation;1==c&&($("#"+b).remove(),this.updateAttachmentEmpty())},show:function(){this._refDOM.show()},hide:function(){this._refDOM.hide()},clearAll:function(){$(".item-attachment-list").empty(),this.updateAttachmentEmpty(),this.reinitScrollbar(),this._scrollApi_attachment_container&&this._scrollApi_attachment_container._refDOM.scrollTop(0)}});window.util.isValidEmail=function(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)},Airdroid.Module.SendEmail=Airdroid.Util.extend(Airdroid.Base,{moduleName:Airdroid.Config.Module.SendEmail,events:{"click .btn-send-email":"sendEmail","click .btn-cancel":"clearAllUserTrigger","click .btn-add-file":"openFileDialog","click .item-empty-tip":"openFileDialog","click .mod-SendEmail-body":"onSendEmailBodyClick","click .item-input-container-topic":"onTopicInputContainerClick"},_construct:function(){},onCreate:function(){var a=this;if(this.clear(),this._refDOM=$(a.util.getTemplate("SendEmail","index")),this.setContent(this._refDOM),this.setBodyHeight(616),Airdroid.Util.isRetina()){var b=$(".btn-add-file img");b.attr("src",b.attr("data-2x-src"))}var c=this.contactSelector=new ContactSelector;c.onAddRecipient=function(){a.reinitScrollbar()},c.onRemoveRecipient=function(){a.reinitScrollbar()},window.contactSelector=c,console.log("onAddRecipien",c),c.createAppView(this),this._refDOM.find(".item-input-container-email").append(c._refDOM),c.setContactType("email");var d=this.attachmentContainer=new AttachmentContainer;if(d.createAppView(this),d.onItemRemove=function(b){a.util.triggerPCInterface(JSON.stringify({action:a.pcApi.emailFileAction.name,id:b,operation:a.pcApi.emailFileAction.action.del})),a.updateButtonState()},d.onRetryUpload=function(b){a.util.triggerPCInterface(JSON.stringify({id:b,action:a.pcApi.emailFileAction.name,operation:a.pcApi.emailFileAction.action.restartUpload}))},this._refDOM.find(".item-add-attachment-container").after(d._refDOM),this.config.isDebug){var e=new Airdroid.Module["Test"+this.moduleName];e.createAppView(this)}this.registerWebInterface({addFileItems:"addFileItems",updateFileProgress:"updateFileProgress",updateFileSpeed:"updateFileSpeed",fileOperate:"fileOperate",setFileState:"setFileState",setSingleLimit:"setSingleLimit",showFailMessage:"showFailMessage",clearAll:"clearAll",getContactData:"getContactData"});var f=Airdroid.Util.getEnv();f&&f.height&&(a.setBodyHeight(parseInt(f.height)),a.onResize({height:parseInt(f.height)}))},onResize:function(a){var b=512,c=85;$("#content").height(Math.max(a.height-b,c)),this.reinitScrollbar()},hasRecipient:function(){var a=this.contactSelector.getRecipients();return a.length>0},isAllEmailValid:function(){var a=this.contactSelector.getRecipients(),b=_.pluck(a,"email");return b.length>0&&_.every(b,util.isValidEmail)},sendEmail:function(){if(this.contactSelector.doInputBlurHandle(),!$(".btn-send-email").hasClass("btn-disabled")){var a=$(".item-error");a.hide();var b=$("#topic").val(),c=$("#content").val(),d=this.contactSelector.getRecipients(),e=_.pluck(d,"email");if(!this.hasRecipient())return void a.filter(".item-error-email-empty").show();if(!this.isAllEmailValid())return void a.filter(".item-error-email-format").show();if(!this.attachmentContainer.hasFinishedFile())return void a.filter(".item-error-content-empty").show();$(".item-loading").removeClass("hide"),$(".btn-send-email").addClass("btn-disabled"),this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.sendEmail.name,email:e.join(";"),topic:b,content:c}))}},onSendEmailBodyClick:function(){this.contactSelector.hideContactFloatPane()},openFileDialog:function(){this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.triggerActive.name,operation:this.pcApi.triggerActive.action.openFileDialog}))},onTopicInputContainerClick:function(){$("#topic").focus()},clearAllUserTrigger:function(){var a=$("#topic").val().trim(),b=$("#content").val().trim(),c=$(".item-error").filter(":not(:hidden)").length>0;(c||a||b||this.hasRecipient()||this.isAllEmailValid()||this.attachmentContainer.hasFile())&&this.util.triggerPCInterface(JSON.stringify({action:this.pcApi.clearEmailFile.name}))},updateButtonState:function(){this.attachmentContainer.isReady()?$(".btn-send-email").removeClass("btn-disabled"):$(".btn-send-email").addClass("btn-disabled")},clearAll:function(){$(".btn-cancel").hasClass("btn-disabled")||($(".inputbar-input").val(""),$("#topic").val(""),$("#content").val(""),$(".item-loading").addClass("hide"),$(".item-error").hide(),$(".btn-send-email").removeClass("btn-disabled"),this.contactSelector.clearAll(),this.attachmentContainer.clearAll())},addFileItems:function(a){this.attachmentContainer.addFileItems(a),this.updateButtonState()},updateFileProgress:function(a){this.attachmentContainer.updateFileProgress(a),this.updateButtonState()},setFileState:function(a){this.attachmentContainer.setFileState(a),this.updateButtonState()},fileOperate:function(a){this.attachmentContainer.fileOperate(a)},updateFileSpeed:function(a){this.attachmentContainer.updateFileSpeed(a)},setSingleLimit:function(a){var b=a.size,c=$(".item-single-limit");0==b?c.parent().addClass("hide"):(c.parent().removeClass("hide"),c.text(b))},showFailMessage:function(a){switch($(".btn-send-email").removeClass("btn-disabled"),$(".btn-cancel").removeClass("btn-disabled"),$(".item-loading").addClass("hide"),a.type.toString()){case"-1":$(".item-error-frequent").show();break;case"0":$(".item-error-fail").show()}},getContactData:function(a){this.contactSelector.getContactData(a)}});